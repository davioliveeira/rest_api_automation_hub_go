# Story 3.2: Execution Logs & Audit

## Status
Approved

## Story
**As a** System Administrator,
**I want** to log workflow executions and task results to the database with complete audit trails,
**so that** I can monitor execution status, debug failures, and maintain a history of all workflow runs.

## Acceptance Criteria
1. **AC1:** Registo persistente de inputs, outputs e status de cada tarefa.

## Tasks / Subtasks

- [ ] Task 1: Define Execution and TaskLog database models
  - [ ] Add Execution model to models.go (ID, WorkflowID, Status, ContextSnapshot JSONB, StartedAt, CompletedAt)
  - [ ] Add TaskLog model to models.go (ID, ExecutionID, TaskID, Status, Input JSONB, Output JSONB, Error, StartedAt, CompletedAt)
  - [ ] Add GORM relationships between models
  - [ ] Create database migrations

- [ ] Task 2: Implement Execution Repository
  - [ ] Create execution_repository.go
  - [ ] Implement Create, GetByID, GetAll, Update operations
  - [ ] Add GetByWorkflowID method

- [ ] Task 3: Implement TaskLog Repository
  - [ ] Create task_log_repository.go
  - [ ] Implement Create and GetByExecutionID operations

- [ ] Task 4: Update Engine to log executions
  - [ ] Modify Engine.Execute() to accept ExecutionRepository
  - [ ] Create Execution record at workflow start
  - [ ] Log each task execution to TaskLog
  - [ ] Update Execution status on completion/failure
  - [ ] Save final context snapshot

- [ ] Task 5: Implement POST /workflows/:id/run endpoint
  - [ ] Load workflow from database
  - [ ] Convert to engine.WorkflowDefinition
  - [ ] Execute workflow with logging
  - [ ] Return 202 Accepted with execution ID

- [ ] Task 6: Implement GET /executions/:id endpoint
  - [ ] Retrieve execution by ID
  - [ ] Include task logs
  - [ ] Return status, context snapshot, and task details

- [ ] Task 7: Add async execution support
  - [ ] Run workflow execution in goroutine
  - [ ] Handle concurrent executions
  - [ ] Add proper error handling

- [ ] Task 8: Write unit tests
  - [ ] Test repository operations
  - [ ] Test Engine logging integration
  - [ ] Test API endpoints
  - [ ] Ensure >80% coverage

- [ ] Task 9: Write integration tests
  - [ ] Test complete workflow execution with logging
  - [ ] Verify task logs created
  - [ ] Verify context snapshot saved

## Dev Notes

### Epic Context

**Epic 1-2:** Foundation + Task Nodes complete
**Epic 3 Story 3.1:** Workflow persistence (database, repository, CRUD endpoints)

**Story 3.2 Adds:**
- Execution tracking (status, timing, context snapshots)
- Task-level logging (inputs, outputs, errors per task)
- Workflow execution endpoint (POST /workflows/:id/run)
- Execution monitoring endpoint (GET /executions/:id)

### Data Models
[Source: architecture/5-data-models.md]

**Execution:**
```go
type Execution struct {
    ID              uuid.UUID       `gorm:"type:uuid;primary_key"`
    WorkflowID      uuid.UUID       `gorm:"type:uuid;not null"`
    Workflow        Workflow        `gorm:"foreignKey:WorkflowID"`
    Status          string          `gorm:"type:varchar(50);not null"` // pending, running, completed, failed
    ContextSnapshot datatypes.JSON  `gorm:"type:jsonb"`
    StartedAt       time.Time       `gorm:"not null"`
    CompletedAt     *time.Time
    CreatedAt       time.Time
}
```

**TaskLog:**
```go
type TaskLog struct {
    ID          uuid.UUID       `gorm:"type:uuid;primary_key"`
    ExecutionID uuid.UUID       `gorm:"type:uuid;not null"`
    Execution   Execution       `gorm:"foreignKey:ExecutionID"`
    TaskID      string          `gorm:"type:varchar(255);not null"`
    TaskType    string          `gorm:"type:varchar(100)"`
    Status      string          `gorm:"type:varchar(50);not null"` // success, failed
    Input       datatypes.JSON  `gorm:"type:jsonb"`
    Output      datatypes.JSON  `gorm:"type:jsonb"`
    Error       string          `gorm:"type:text"`
    StartedAt   time.Time       `gorm:"not null"`
    CompletedAt time.Time       `gorm:"not null"`
}
```

### REST API Spec
[Source: architecture/9-rest-api-spec.md]

**POST /workflows/:id/run:** Execute workflow asynchronously (202 Accepted)
**GET /executions/:id:** Monitor execution status and view task logs

### Engine Integration

Current Engine.Execute signature:
```go
func (e *Engine) Execute(workflow WorkflowDefinition) error
```

Updated signature:
```go
func (e *Engine) Execute(workflow WorkflowDefinition, execRepo ExecutionRepository, taskLogRepo TaskLogRepository) (*Execution, error)
```

### Core Workflow
[Source: architecture/8-core-workflows.md]

Execution flow with logging:
1. Create Execution record (status: running)
2. For each task:
   - Create TaskLog (status: running)
   - Execute task
   - Update TaskLog (status: success/failed, output/error)
3. Save context snapshot
4. Update Execution (status: completed/failed)

### Success Criteria

1. ✅ Execution and TaskLog models created
2. ✅ Repository implementations with CRUD operations
3. ✅ Engine logs all executions and tasks
4. ✅ POST /workflows/:id/run executes and returns execution ID
5. ✅ GET /executions/:id returns status and logs
6. ✅ Async execution support (goroutines)
7. ✅ Unit and integration tests >80% coverage
8. ✅ Complete audit trail of workflow runs

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-16 | 1.0 | Initial story draft | Bob (SM) |

## Dev Agent Record

### Agent Model Used
*To be filled by Dev Agent*

### Debug Log References
*To be filled by Dev Agent*

### Completion Notes List
*To be filled by Dev Agent*

### File List
*To be filled by Dev Agent*

## QA Results

*To be filled by QA Agent*
