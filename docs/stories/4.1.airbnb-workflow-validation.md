# Story 4.1: Execucao do Workflow Airbnb

## Status
Ready for Review

## Story
**As a** Developer/Portfolio Reviewer,
**I want** to execute a complete end-to-end workflow that simulates Airbnb listing scraping,
**so that** I can validate the MVP is working correctly with all task types integrated.

## Acceptance Criteria
1. **AC1:** Sucesso na execucao: Fetch -> Parse -> Transform via trigger de API.
2. **AC2:** Workflow executado atraves de POST /workflows/:id/run com retorno 202 Accepted.
3. **AC3:** Execucao registada no sistema de logs (Execution + TaskLog) com status "completed".
4. **AC4:** Context snapshot final contem os dados extraidos do HTML parseado.
5. **AC5:** Teste de integracao end-to-end passa com servidor mock simulando pagina Airbnb.

## Tasks / Subtasks

- [x] Task 1: Criar ficheiro de workflow JSON de validacao (AC: 1)
  - [x] Definir workflow "airbnb-price-monitor" com 3 tasks sequenciais
  - [x] Task http_request: GET para endpoint mock
  - [x] Task html_parser: extrair titulos, precos, ratings, locations
  - [x] Task transform: formatar output estruturado final
  - [x] Guardar como fixture em testdata/workflows/airbnb-validation.json

- [x] Task 2: Criar servidor mock para simulacao Airbnb (AC: 1, 5)
  - [x] Implementar handler HTTP que retorna HTML realista de listings
  - [x] Incluir estrutura HTML similar ao integration_test existente
  - [x] Suportar multiplos listings (minimo 3) com dados variados

- [x] Task 3: Implementar teste de integracao E2E completo (AC: 1, 2, 3, 4, 5)
  - [x] Criar ficheiro internal/e2e/airbnb_validation_test.go
  - [x] Setup: iniciar servidor mock, criar workflow via API
  - [x] Execucao: POST /workflows/:id/run
  - [x] Verificacao: polling GET /executions/:id ate status "completed"
  - [x] Validacao: verificar TaskLogs criados para cada task
  - [x] Validacao: verificar context_snapshot contem dados extraidos
  - [x] Cleanup: remover workflow de teste

- [x] Task 4: Documentar workflow de validacao MVP (AC: 1)
  - [x] Adicionar comentarios no ficheiro de workflow JSON
  - [x] Descrever o fluxo de dados entre tasks

- [x] Task 5: Executar validacao manual e verificar logs (AC: 2, 3, 4)
  - [x] Validacao automatizada via teste E2E (substitui validacao manual)
  - [x] Teste verifica resposta 202 Accepted
  - [x] Teste verifica status "completed"
  - [x] Teste verifica TaskLogs e context_snapshot
  - [x] Documentar resultado no Dev Agent Record

## Dev Notes

### Epic Context

**Epicos 1-3 Completos:**
- Epic 1: Foundation (Engine, Context, Registry)
- Epic 2: Task Nodes (http_request, html_parser, transform)
- Epic 3: Persistence (Workflow CRUD, Execution Logs)

**Story 4.1 Valida:**
- Integracao completa de todos os componentes
- Fluxo real de scraping: HTTP -> Parse -> Transform
- Sistema de logging funcionando end-to-end
- API REST para triggering de workflows

### Nota sobre Database Task
[Source: PRD - FR6]
O PRD menciona `database_query` task, mas este NAO foi implementado no MVP.
A persistencia acontece atraves do sistema de Execution/TaskLog ja existente.
O fluxo de validacao usa: http_request -> html_parser -> transform

### Tasks Disponiveis
[Source: internal/tasks/]

```go
// Registados no sistema:
"http_request" - HTTPTask (GET/POST, headers, body interpolation)
"html_parser"  - HTMLParserTask (CSS selectors via Goquery)
"transform"    - TransformTask (text/template com funcoes custom)
```

### API Endpoints
[Source: cmd/api/handlers.go]

```
POST /workflows           - Criar workflow
GET  /workflows/:id       - Obter workflow
POST /workflows/:id/run   - Executar workflow (202 Accepted)
GET  /executions/:id      - Obter execucao com TaskLogs
```

### Estrutura do Workflow JSON
[Source: internal/engine/types.go]

```go
type WorkflowDefinition struct {
    Name  string `json:"name"`
    Tasks []Task `json:"tasks"`
}

type Task struct {
    ID     string                 `json:"id"`
    Type   string                 `json:"type"`
    Config map[string]interface{} `json:"config"`
}
```

### Exemplo de Workflow Airbnb
[Source: internal/tasks/integration_test.go - TestHTMLParserTask_IntegrationWithRealWorldHTML]

```json
{
  "name": "airbnb-price-monitor",
  "tasks": [
    {
      "id": "fetch_listings",
      "type": "http_request",
      "config": {
        "method": "GET",
        "url": "{{mock_server_url}}"
      }
    },
    {
      "id": "parse_listings",
      "type": "html_parser",
      "config": {
        "html_source": "fetch_listings_result",
        "selectors": [
          {"name": "titles", "selector": ".listing-title", "multiple": true},
          {"name": "prices", "selector": ".price-amount", "multiple": true},
          {"name": "locations", "selector": ".listing-location", "multiple": true},
          {"name": "ratings", "selector": ".rating-score", "multiple": true}
        ]
      }
    },
    {
      "id": "format_output",
      "type": "transform",
      "config": {
        "data_source": "parse_listings_result",
        "template": "{\"listing_count\": {{len (index . 0).titles}}, \"data\": {{json .}}}",
        "output_format": "json"
      }
    }
  ]
}
```

### Estrutura de Dados Esperada no Context
[Source: internal/tasks/integration_test.go]

Apos execucao bem sucedida, o context_snapshot deve conter:
- `fetch_listings_result`: {status_code, headers, body}
- `parse_listings_result`: [{titles: [...], prices: [...], locations: [...], ratings: [...]}]
- `format_output_result`: {listing_count: N, data: [...]}

### Source Tree Relevante
[Source: project structure]

```
cmd/api/
  main.go           - Setup servidor e rotas
  handlers.go       - Handlers REST incluindo /run
internal/
  engine/
    engine.go       - ExecuteWithLogging()
    types.go        - WorkflowDefinition, Task
  tasks/
    http_task.go
    html_parser_task.go
    transform_task.go
    integration_test.go  - Testes existentes como referencia
  repository/
    execution_repository.go
    task_log_repository.go
    execution_logger.go  - Adapter para Engine
```

### Testing

**Localizacao:** `internal/e2e/airbnb_validation_test.go`

**Padrao de Teste E2E:**
```go
func TestAirbnbWorkflowValidation(t *testing.T) {
    // 1. Setup mock server
    // 2. Start test API server
    // 3. Create workflow via POST /workflows
    // 4. Execute via POST /workflows/:id/run
    // 5. Poll GET /executions/:id until completed
    // 6. Assert TaskLogs and context_snapshot
    // 7. Cleanup
}
```

**Frameworks:** testify/assert, net/http/httptest

**Coverage:** Este teste valida integracao, nao contribui para coverage unitaria

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-18 | 1.0 | Initial story draft | Bob (SM) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
N/A - No debug issues encountered

### Completion Notes List
- All 5 tasks completed successfully
- E2E test validates all 5 acceptance criteria
- Test passes with 3 mock Airbnb listings (Beach House, Mountain Cabin, City Loft)
- Context snapshot correctly contains extracted data (titles, prices, locations, ratings)
- All TaskLogs created with "success" status for fetch_listings, parse_listings, format_output
- Full regression tests pass (all existing tests + new E2E tests)

### File List
**Created:**
- `testdata/workflows/airbnb-validation.json` - Workflow JSON fixture
- `testdata/workflows/README.md` - Workflow documentation
- `internal/e2e/airbnb_validation_test.go` - E2E test with mock server and in-memory repositories

**Modified:**
- `docs/stories/4.1.airbnb-workflow-validation.md` - Updated tasks and Dev Agent Record

## QA Results

*To be filled by QA Agent*
