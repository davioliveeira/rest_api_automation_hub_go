# Story 5.1: GitHub Actions CI Pipeline com Coverage

## Status
Approved

## Story
**As a** Developer/Portfolio Reviewer,
**I want** a CI pipeline that runs tests, linting and generates coverage reports on every push/PR,
**so that** I can demonstrate professional DevOps practices and maintain code quality automatically.

## Acceptance Criteria
1. **AC1:** GitHub Actions workflow executa em cada push para `main` e em cada Pull Request.
2. **AC2:** Pipeline executa `go build ./...` com sucesso.
3. **AC3:** Pipeline executa `go test ./...` com todos os testes passando.
4. **AC4:** Pipeline executa linting via `golangci-lint` sem erros.
5. **AC5:** Coverage report gerado e disponivel como artifact.
6. **AC6:** Badge de coverage visivel no README.md.
7. **AC7:** Pipeline falha se testes ou build falharem (blocking merge).

## Tasks / Subtasks

- [ ] Task 1: Criar workflow file para GitHub Actions (AC: 1, 2, 3, 7)
  - [ ] Criar `.github/workflows/ci.yml`
  - [ ] Configurar trigger para push (main) e pull_request
  - [ ] Configurar Go version matrix (1.24)
  - [ ] Adicionar step de checkout
  - [ ] Adicionar step de setup-go
  - [ ] Adicionar step de build
  - [ ] Adicionar step de test com coverage

- [ ] Task 2: Adicionar linting ao pipeline (AC: 4, 7)
  - [ ] Adicionar golangci-lint action
  - [ ] Criar `.golangci.yml` config file (opcional mas recomendado)
  - [ ] Configurar linters relevantes para Go

- [ ] Task 3: Configurar coverage report (AC: 5, 6)
  - [ ] Gerar coverage.out durante tests
  - [ ] Upload coverage como artifact
  - [ ] Integrar com servi√ßo de coverage (Codecov ou similar)
  - [ ] Adicionar coverage badge ao README.md

- [ ] Task 4: Testar pipeline localmente (AC: 1-7)
  - [ ] Usar `act` ou push para branch de teste
  - [ ] Verificar todos os steps executam correctamente
  - [ ] Verificar artifacts sao gerados

- [ ] Task 5: Documentar pipeline no README (AC: 6)
  - [ ] Adicionar badge de CI status
  - [ ] Adicionar badge de coverage
  - [ ] Documentar como executar testes localmente

## Dev Notes

### Contexto do Projeto
Este projeto usa:
- **Go 1.24+** (verificar go.mod)
- **Testes com testify/assert**
- **Estrutura:** cmd/api, internal/engine, internal/tasks, internal/repository, internal/e2e

### Source Tree Relevante
```
.github/
  workflows/
    ci.yml           <- CRIAR
.golangci.yml        <- CRIAR (opcional)
README.md            <- MODIFICAR (badges)
go.mod               <- Referencia para Go version
```

### Exemplo de Workflow GitHub Actions para Go
```yaml
name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Build
        run: go build -v ./...

      - name: Test with Coverage
        run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          fail_ci_if_error: false

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
```

### Coverage Badge Options

**Opcao 1: Codecov (Recomendado - Gratuito para open source)**
```markdown
[![codecov](https://codecov.io/gh/USER/REPO/branch/main/graph/badge.svg)](https://codecov.io/gh/USER/REPO)
```

**Opcao 2: GitHub Actions Badge**
```markdown
![CI](https://github.com/USER/REPO/actions/workflows/ci.yml/badge.svg)
```

### golangci-lint Config Sugerida
```yaml
# .golangci.yml
run:
  timeout: 5m

linters:
  enable:
    - errcheck
    - gosimple
    - govet
    - ineffassign
    - staticcheck
    - unused

issues:
  exclude-use-default: false
```

### Testing

**Verificacao Local:**
```bash
# Instalar act para testar workflows localmente (opcional)
brew install act

# Ou simplesmente executar os comandos do workflow:
go build ./...
go test -v -race -coverprofile=coverage.out ./...
golangci-lint run
```

**Verificacao Remota:**
- Push para branch de feature
- Verificar tab "Actions" no GitHub
- Confirmar todos os jobs passam

### Notas Importantes
- O repositorio deve estar no GitHub para os Actions funcionarem
- Codecov requer conta gratuita e token (para repos privados)
- Para repos publicos, Codecov funciona sem configuracao adicional
- A primeira execucao pode demorar mais (download de dependencias)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-18 | 1.0 | Initial story draft | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
*To be filled by Dev Agent*

### Debug Log References
*To be filled by Dev Agent*

### Completion Notes List
*To be filled by Dev Agent*

### File List
*To be filled by Dev Agent*

## QA Results

*To be filled by QA Agent*
